# Experimental SD Card MUX STM32F407 demo

## Brief
- The demo exercises the experimental 6-slot SD MUX hardware under development
- An STM32F407 Discovery board is used as the driver (we had one kicking around)

## Project Structure
- This is an STM32CubeIDE C-language project for STM32F407VGT6
- STM32 auto generated peripheral code goes into `./Core/`, `./Drivers/`, `./FATFS/`, and `./Middlewares/`
- Do not modify any code in the autogenerated files unless you really know what you're doing
- Custom library modules are placed in `./lib/` as .h/.c file pairs
- The main application is in `./app/`, and `./app/app_main.c` has the main infinite loop. This function is called by the autogenerated `./Core/Src/main.c`

## What to Expect
This demo attempts to write a simple file to each of the 6 SD cards in the card bank and blinks the LEDs according to the pattern below:

- If a given card is not inserted then the Blue LED blinks a few times before moving on to the next card
- If there is an error mounting the card then the Red LED blinks a few times and it moves to the next card
- Errors opening or writing the file result in the Orange LED blinking before moving to the next card
- If writing the file is successful  then the Green LED blinks, and onto the next card

After all 6 card slots are handled, a LED pattern indicating the successes and failures of the whole run blinks forever:

- The Green LED blinks once per each card where writing was successful
- One Blue blink for each slot with no card detected
- The Red LED blinks once for each slot with mount errors
- The orange LED blinks once for each slot with file IO errors

### To run the demo:
The SD MUX board must be connected to the SDIO, I2C, and power pins on the Discovery board. Ask Jordan for help here.

Insert any number of SD cards in the slots and power on the program. Watch the LEDs on the Discovery for info about the success or failure of a given SD card. After all cards are complete, remove the cards and check the files on them.

## Quirks
- I used a "dummy" GPIO pin as the SD card detect for the FatFS library. It requires a GPIO pin configured as the detect pin. There are probably ways to do this without wasting a GPIO pin
- I did not place a pullup for the `CMD` line, but it fails to write to some SD cards if I don't enable the internal pullup for `CMD`, investigate this, I guess it needs the pullup on `CMD` after all...
- The SD card writes fail if the SDIO clock is above 8MHz. In theory we should be able to get up to around 50MHz, but the current setup is not great for signal integrity
    - When we move this to a real project with good PCB layout, try inching up the SDIO clock speed to find the real max speed
- Error handling could be improved
